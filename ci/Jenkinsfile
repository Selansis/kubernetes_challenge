pipeline {
    agent any 
    
    // ... (parametry)

    stages {
        
        stage('Initialize & Validate') {
            steps { // <--- KLUCZOWE: USTAWIANIE ZMIENNEJ W BLOKU 'steps'
                env.AWS_DEFAULT_REGION = params.AWS_REGION 
                
                echo "Uruchamiam inicjalizację i walidację w regionie ${env.AWS_DEFAULT_REGION}."
                
                dir('infrastructure') {
                    sh 'terraform init' 
                    sh 'terraform validate'
                }
            } // <--- KONIEC BLOKU 'steps'
        }
        
        stage('Terraform Build (Plan & Apply)') {
            when { expression { return params.ACTION == 'build' } }
            steps { // <--- W KAŻDYM ETAPIE WARUNKOWYM POTRZEBNY JEST BLOK 'steps'
                script {
                    // ... komendy sh
                }
            }
        }

        stage('Terraform Destroy') {
            when { expression { return params.ACTION == 'destroy' } }
            steps { // <--- W KAŻDYM ETAPIE WARUNKOWYM POTRZEBNY JEST BLOK 'steps'
                script {
                    // ... komendy sh
                }
            }
        }
    }
}